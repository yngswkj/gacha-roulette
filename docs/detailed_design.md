# ãƒãƒ¼ãƒ æŠ½é¸ã‚¬ãƒãƒ£ã‚¬ãƒãƒ£ - è©³ç´°è¨­è¨ˆæ›¸

ä½œæˆæ—¥: 2025å¹´11æœˆ3æ—¥
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0

---

## ğŸ“‘ ç›®æ¬¡

1. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ](#1-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ)
2. [ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ](#2-ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ)
3. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ](#3-ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ)
4. [ç‰©ç†æ¼”ç®—ã‚¨ãƒ³ã‚¸ãƒ³è¨­è¨ˆ](#4-ç‰©ç†æ¼”ç®—ã‚¨ãƒ³ã‚¸ãƒ³è¨­è¨ˆ)
5. [UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ](#5-uiã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ)
6. [ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»æ¼”å‡ºè¨­è¨ˆ](#6-ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ¼”å‡ºè¨­è¨ˆ)
7. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ](#7-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ)
8. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–](#8-ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)
9. [å®Ÿè£…è©³ç´°](#9-å®Ÿè£…è©³ç´°)

---

## 1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### 1.1 ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Application Layer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  MainScreen  â”‚  â”‚ GachaScreen  â”‚  â”‚ResultScreenâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                 â”‚                 â”‚        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   Business Logic Layer               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ TeamManager  â”‚  â”‚GachaOrchest. â”‚  â”‚AnimationMgrâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                 â”‚                 â”‚        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Service Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚StorageServiceâ”‚  â”‚PhysicsEngine â”‚  â”‚ AudioMgr  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ãƒ¬ã‚¤ãƒ¤ãƒ¼è²¬å‹™

#### Application Layer (View)
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®æç”»
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®å—ä»˜
- ç”»é¢é·ç§»ã®åˆ¶å¾¡

#### Business Logic Layer
- ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†ãƒ»æ“ä½œ
- æŠ½é¸ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ
- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®åˆ¶å¾¡

#### Service Layer
- ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ï¼ˆLocalStorageï¼‰
- ç‰©ç†æ¼”ç®—ï¼ˆMatter.jsï¼‰
- åŠ¹æœéŸ³å†ç”Ÿï¼ˆWeb Audio APIï¼‰

### 1.3 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾å­˜é–¢ä¿‚

```
app.js (Main Controller)
  â”œâ”€> storage.js (Storage Service)
  â”œâ”€> teamManager.js (Team Business Logic)
  â”œâ”€> gachaOrchestrator.js (Gacha Orchestration)
  â”‚     â”œâ”€> gacha.js (Physics Engine)
  â”‚     â”œâ”€> audioManager.js (Audio Service)
  â”‚     â””â”€> animationManager.js (Animation Control)
  â””â”€> uiController.js (UI Management)
```

---

## 2. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ

### 2.1 storage.js - ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

#### è²¬å‹™
- LocalStorageã¸ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜/èª­ã¿è¾¼ã¿
- ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ä¿è¨¼
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ

#### ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```javascript
class StorageService {
  /**
   * ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
   * @param {Team[]} teams - ãƒãƒ¼ãƒ é…åˆ—
   * @returns {boolean} æˆåŠŸ/å¤±æ•—
   */
  saveTeams(teams)

  /**
   * ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
   * @returns {Team[]} ãƒãƒ¼ãƒ é…åˆ—
   */
  loadTeams()

  /**
   * å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
   * @returns {boolean} æˆåŠŸ/å¤±æ•—
   */
  clearAll()

  /**
   * ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰
   * @returns {string} JSONæ–‡å­—åˆ—
   */
  exportData()

  /**
   * ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰
   * @param {string} jsonData - JSONæ–‡å­—åˆ—
   * @returns {boolean} æˆåŠŸ/å¤±æ•—
   */
  importData(jsonData)
}
```

#### ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒ

```typescript
interface Team {
  id: string;              // UUID v4
  name: string;            // ãƒãƒ¼ãƒ åï¼ˆ1-50æ–‡å­—ï¼‰
  isWinner: boolean;       // å½“é¸æ¸ˆã¿ãƒ•ãƒ©ã‚°
  color: string;           // HEXè‰²ã‚³ãƒ¼ãƒ‰ (#RRGGBB)
  createdAt: number;       // Unix timestamp (ms)
  updatedAt: number;       // Unix timestamp (ms)
}

interface StorageData {
  version: string;         // ã‚¹ã‚­ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ "1.0"
  teams: Team[];
  lastModified: number;    // Unix timestamp (ms)
}
```

#### å®Ÿè£…è©³ç´°

```javascript
const STORAGE_KEY = 'gacha_teams_v1';
const SCHEMA_VERSION = '1.0';
const MAX_TEAMS = 50;

class StorageService {
  constructor() {
    this.validateBrowserSupport();
  }

  validateBrowserSupport() {
    if (!window.localStorage) {
      throw new Error('LocalStorage is not supported');
    }
  }

  saveTeams(teams) {
    try {
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!Array.isArray(teams)) {
        throw new Error('Teams must be an array');
      }

      if (teams.length > MAX_TEAMS) {
        throw new Error(`Maximum ${MAX_TEAMS} teams allowed`);
      }

      const data = {
        version: SCHEMA_VERSION,
        teams: teams.map(team => ({
          ...team,
          updatedAt: Date.now()
        })),
        lastModified: Date.now()
      };

      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      return true;
    } catch (error) {
      console.error('Failed to save teams:', error);
      return false;
    }
  }

  loadTeams() {
    try {
      const data = localStorage.getItem(STORAGE_KEY);

      if (!data) {
        return this.getDefaultTeams();
      }

      const parsed = JSON.parse(data);

      // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
      if (parsed.version !== SCHEMA_VERSION) {
        return this.migrateData(parsed);
      }

      return parsed.teams || [];
    } catch (error) {
      console.error('Failed to load teams:', error);
      return this.getDefaultTeams();
    }
  }

  getDefaultTeams() {
    return [
      {
        id: this.generateId(),
        name: 'å–¶æ¥­ãƒãƒ¼ãƒ ',
        isWinner: false,
        color: '#FF6B6B',
        createdAt: Date.now(),
        updatedAt: Date.now()
      },
      {
        id: this.generateId(),
        name: 'é–‹ç™ºãƒãƒ¼ãƒ ',
        isWinner: false,
        color: '#4ECDC4',
        createdAt: Date.now(),
        updatedAt: Date.now()
      },
      {
        id: this.generateId(),
        name: 'ä¼ç”»ãƒãƒ¼ãƒ ',
        isWinner: false,
        color: '#95E1D3',
        createdAt: Date.now(),
        updatedAt: Date.now()
      },
      {
        id: this.generateId(),
        name: 'äººäº‹ãƒãƒ¼ãƒ ',
        isWinner: false,
        color: '#FFE66D',
        createdAt: Date.now(),
        updatedAt: Date.now()
      },
      {
        id: this.generateId(),
        name: 'ç·å‹™ãƒãƒ¼ãƒ ',
        isWinner: false,
        color: '#C77DFF',
        createdAt: Date.now(),
        updatedAt: Date.now()
      }
    ];
  }

  generateId() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  migrateData(oldData) {
    // å°†æ¥ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—å¯¾å¿œ
    console.warn('Data migration needed');
    return this.getDefaultTeams();
  }
}
```

### 2.2 teamManager.js - ãƒãƒ¼ãƒ ç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

#### è²¬å‹™
- ãƒãƒ¼ãƒ ã®CRUDæ“ä½œ
- æŠ½é¸å¯¾è±¡ãƒãƒ¼ãƒ ã®é¸å®š
- å½“é¸å‡¦ç†

#### ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```javascript
class TeamManager {
  /**
   * ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
   * @param {StorageService} storage - ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹
   */
  constructor(storage)

  /**
   * å…¨ãƒãƒ¼ãƒ ã‚’å–å¾—
   * @returns {Team[]} ãƒãƒ¼ãƒ é…åˆ—
   */
  getAllTeams()

  /**
   * ãƒãƒ¼ãƒ ã‚’è¿½åŠ 
   * @param {string} name - ãƒãƒ¼ãƒ å
   * @param {string} color - ã‚«ãƒ—ã‚»ãƒ«è‰²
   * @returns {Team} è¿½åŠ ã•ã‚ŒãŸãƒãƒ¼ãƒ 
   */
  addTeam(name, color)

  /**
   * ãƒãƒ¼ãƒ ã‚’æ›´æ–°
   * @param {string} id - ãƒãƒ¼ãƒ ID
   * @param {Partial<Team>} updates - æ›´æ–°å†…å®¹
   * @returns {Team} æ›´æ–°ã•ã‚ŒãŸãƒãƒ¼ãƒ 
   */
  updateTeam(id, updates)

  /**
   * ãƒãƒ¼ãƒ ã‚’å‰Šé™¤
   * @param {string} id - ãƒãƒ¼ãƒ ID
   * @returns {boolean} æˆåŠŸ/å¤±æ•—
   */
  deleteTeam(id)

  /**
   * æœªå½“é¸ãƒãƒ¼ãƒ ã‚’å–å¾—
   * @returns {Team[]} æœªå½“é¸ãƒãƒ¼ãƒ é…åˆ—
   */
  getEligibleTeams()

  /**
   * ãƒãƒ¼ãƒ ã‚’å½“é¸æ¸ˆã¿ã«ãƒãƒ¼ã‚¯
   * @param {string} id - ãƒãƒ¼ãƒ ID
   * @returns {Team} æ›´æ–°ã•ã‚ŒãŸãƒãƒ¼ãƒ 
   */
  markAsWinner(id)

  /**
   * å…¨ãƒãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæœªå½“é¸ã«æˆ»ã™ï¼‰
   * @returns {boolean} æˆåŠŸ/å¤±æ•—
   */
  resetAllTeams()

  /**
   * ãƒ©ãƒ³ãƒ€ãƒ ãªè‰²ã‚’ç”Ÿæˆ
   * @returns {string} HEXè‰²ã‚³ãƒ¼ãƒ‰
   */
  generateRandomColor()
}
```

#### å®Ÿè£…è©³ç´°

```javascript
const COLOR_PALETTE = [
  '#FF6B6B', '#4ECDC4', '#95E1D3', '#FFE66D', '#C77DFF',
  '#FF8C94', '#A8E6CF', '#FFD3B6', '#FFAAA5', '#B4A7D6',
  '#FF9AA2', '#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7'
];

class TeamManager {
  constructor(storage) {
    this.storage = storage;
    this.teams = storage.loadTeams();
    this.eventListeners = new Map();
  }

  getAllTeams() {
    return [...this.teams]; // é˜²å¾¡çš„ã‚³ãƒ”ãƒ¼
  }

  addTeam(name, color = null) {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!name || name.trim().length === 0) {
      throw new Error('Team name cannot be empty');
    }

    if (name.length > 50) {
      throw new Error('Team name too long (max 50 characters)');
    }

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
    if (this.teams.some(t => t.name === name.trim())) {
      throw new Error('Team name already exists');
    }

    const newTeam = {
      id: this.storage.generateId(),
      name: name.trim(),
      isWinner: false,
      color: color || this.generateRandomColor(),
      createdAt: Date.now(),
      updatedAt: Date.now()
    };

    this.teams.push(newTeam);
    this.persist();
    this.emit('teamAdded', newTeam);

    return newTeam;
  }

  updateTeam(id, updates) {
    const index = this.teams.findIndex(t => t.id === id);

    if (index === -1) {
      throw new Error('Team not found');
    }

    const team = this.teams[index];
    const updatedTeam = {
      ...team,
      ...updates,
      id: team.id, // IDã¯å¤‰æ›´ä¸å¯
      createdAt: team.createdAt, // ä½œæˆæ—¥æ™‚ã¯å¤‰æ›´ä¸å¯
      updatedAt: Date.now()
    };

    this.teams[index] = updatedTeam;
    this.persist();
    this.emit('teamUpdated', updatedTeam);

    return updatedTeam;
  }

  deleteTeam(id) {
    const index = this.teams.findIndex(t => t.id === id);

    if (index === -1) {
      return false;
    }

    const deletedTeam = this.teams[index];
    this.teams.splice(index, 1);
    this.persist();
    this.emit('teamDeleted', deletedTeam);

    return true;
  }

  getEligibleTeams() {
    return this.teams.filter(t => !t.isWinner);
  }

  markAsWinner(id) {
    return this.updateTeam(id, { isWinner: true });
  }

  resetAllTeams() {
    this.teams = this.teams.map(team => ({
      ...team,
      isWinner: false,
      updatedAt: Date.now()
    }));

    this.persist();
    this.emit('allTeamsReset');

    return true;
  }

  generateRandomColor() {
    // æ—¢å­˜ãƒãƒ¼ãƒ ã§ä½¿ã‚ã‚Œã¦ã„ãªã„è‰²ã‚’å„ªå…ˆ
    const usedColors = new Set(this.teams.map(t => t.color));
    const availableColors = COLOR_PALETTE.filter(c => !usedColors.has(c));

    if (availableColors.length > 0) {
      return availableColors[Math.floor(Math.random() * availableColors.length)];
    }

    // å…¨è‰²ä½¿ç”¨æ¸ˆã¿ã®å ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆ
    return '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
  }

  persist() {
    this.storage.saveTeams(this.teams);
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆã‚¨ãƒŸãƒƒã‚¿ãƒ¼
  on(event, callback) {
    if (!this.eventListeners.has(event)) {
      this.eventListeners.set(event, []);
    }
    this.eventListeners.get(event).push(callback);
  }

  emit(event, data) {
    const listeners = this.eventListeners.get(event);
    if (listeners) {
      listeners.forEach(callback => callback(data));
    }
  }
}
```

---

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

### 3.1 çŠ¶æ…‹ç®¡ç†

```javascript
// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®çŠ¶æ…‹
const AppState = {
  // ç”»é¢çŠ¶æ…‹
  currentScreen: 'main', // 'main' | 'gacha' | 'result'

  // ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
  teams: [],

  // æŠ½é¸çŠ¶æ…‹
  gachaState: {
    isRunning: false,
    currentPhase: null, // null | 'drop' | 'shuffle' | 'extract' | 'roll' | 'reveal'
    selectedTeam: null,
    progress: 0 // 0-100
  },

  // UIçŠ¶æ…‹
  ui: {
    isEditMode: false,
    selectedTeamId: null,
    showSettings: false
  }
};
```

### 3.2 ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ]
     â†“
[UIã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©]
     â†“
[ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ]
     â†“
[çŠ¶æ…‹æ›´æ–°]
     â†“
[ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜]
     â†“
[UIå†æç”»]
```

### 3.3 æŠ½é¸ãƒ•ãƒ­ãƒ¼

```
1. æŠ½é¸é–‹å§‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
   â†“
2. æœªå½“é¸ãƒã‚§ãƒƒã‚¯ï¼ˆ0ä»¶ãªã‚‰ã‚¨ãƒ©ãƒ¼ï¼‰
   â†“
3. ç”»é¢é·ç§»ï¼ˆmain â†’ gachaï¼‰
   â†“
4. ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–
   â†“
5. ãƒ•ã‚§ãƒ¼ã‚º1: ã‚«ãƒ—ã‚»ãƒ«æŠ•å…¥ï¼ˆ2ç§’ï¼‰
   - ã‚«ãƒ—ã‚»ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ
   - æ™‚é–“å·®ã§è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
   - åŠ¹æœéŸ³å†ç”Ÿ
   â†“
6. ãƒ•ã‚§ãƒ¼ã‚º2: ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆ3ç§’ï¼‰
   - å®¹å™¨æºã‚‰ã—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
   - ã‚«ãƒ—ã‚»ãƒ«ã«åŠ›ã‚’åŠ ãˆã‚‹
   - åŠ¹æœéŸ³å†ç”Ÿ
   â†“
7. ãƒ•ã‚§ãƒ¼ã‚º3: å–ã‚Šå‡ºã—ï¼ˆ2ç§’ï¼‰
   - åº•ã®ç©´ã‚’é–‹ã
   - å½“é¸ã‚«ãƒ—ã‚»ãƒ«é¸å®š
   - ã‚¹ãƒ­ãƒ¼ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
   â†“
8. ãƒ•ã‚§ãƒ¼ã‚º4: è»¢ãŒã‚Šï¼ˆ1.5ç§’ï¼‰
   - ã‚¹ãƒ­ãƒ¼ãƒ—ã‚’è»¢ãŒã‚‹
   - ãƒˆãƒ¬ã‚¤åˆ°ç€
   â†“
9. ãƒ•ã‚§ãƒ¼ã‚º5: é–‹å°ï¼ˆ2ç§’ï¼‰
   - ç”»é¢é·ç§»ï¼ˆgacha â†’ resultï¼‰
   - ã‚«ãƒ—ã‚»ãƒ«é–‹å°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
   - ãƒãƒ¼ãƒ åè¡¨ç¤º
   - ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
   - ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬
   â†“
10. å½“é¸ãƒãƒ¼ãƒ ã‚’ãƒãƒ¼ã‚¯
   â†“
11. ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜
```

---

## 4. ç‰©ç†æ¼”ç®—ã‚¨ãƒ³ã‚¸ãƒ³è¨­è¨ˆ

### 4.1 gacha.js - ç‰©ç†æ¼”ç®—ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

#### è²¬å‹™
- Matter.jsã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–ãƒ»ç®¡ç†
- ç‰©ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿæˆãƒ»æ“ä½œ
- è¡çªæ¤œçŸ¥ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚§ãƒ¼ã‚ºã®å®Ÿè¡Œ

#### ã‚¯ãƒ©ã‚¹è¨­è¨ˆ

```javascript
class GachaPhysicsEngine {
  constructor(canvasElement, config = {})

  // åˆæœŸåŒ–
  initialize(teams)

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡
  startAnimation()
  pauseAnimation()
  resumeAnimation()
  stopAnimation()

  // ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿè¡Œ
  async executePhase1_Drop()
  async executePhase2_Shuffle()
  async executePhase3_Extract()
  async executePhase4_Roll()

  // ç‰©ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ
  createCapsule(team, x, y)
  createContainer()
  createSlope()
  createTray()

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  cleanup()
  setTimeScale(scale)
  highlightCapsule(capsule)
}
```

#### ç‰©ç†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°

```javascript
const PHYSICS_CONFIG = {
  // ã‚¨ãƒ³ã‚¸ãƒ³è¨­å®š
  engine: {
    gravity: {
      x: 0,
      y: 1.0 // åœ°çƒã®é‡åŠ›
    },
    enableSleeping: false,
    timing: {
      timeScale: 1.0
    }
  },

  // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼è¨­å®š
  render: {
    width: 800,
    height: 600,
    wireframes: false,
    background: 'transparent',
    pixelRatio: window.devicePixelRatio || 1
  },

  // ã‚«ãƒ—ã‚»ãƒ«è¨­å®š
  capsule: {
    radius: 35,
    restitution: 0.8,    // åç™ºä¿‚æ•°ï¼ˆ0-1ï¼‰é«˜ã„ã»ã©å¼¾ã‚€
    friction: 0.05,      // æ‘©æ“¦ä¿‚æ•°ï¼ˆ0-1ï¼‰
    frictionAir: 0.01,   // ç©ºæ°—æŠµæŠ—ï¼ˆ0-1ï¼‰
    density: 0.04,       // å¯†åº¦
    slop: 0.05,          // è²«é€šè¨±å®¹å€¤
    render: {
      fillStyle: '#FF6B6B',
      strokeStyle: '#000',
      lineWidth: 2
    }
  },

  // å®¹å™¨è¨­å®š
  container: {
    floor: {
      x: 400,
      y: 550,
      width: 700,
      height: 40,
      isStatic: true,
      render: {
        fillStyle: '#2a2a3e'
      }
    },
    leftWall: {
      x: 50,
      y: 300,
      width: 40,
      height: 500,
      isStatic: true
    },
    rightWall: {
      x: 750,
      y: 300,
      width: 40,
      height: 500,
      isStatic: true
    }
  },

  // å–ã‚Šå‡ºã—å£è¨­å®š
  exitSensor: {
    x: 400,
    y: 540,
    width: 80,
    height: 20,
    isSensor: true,
    isStatic: true,
    render: {
      fillStyle: '#FFD700',
      opacity: 0.5
    }
  },

  // ã‚¹ãƒ­ãƒ¼ãƒ—è¨­å®š
  slope: {
    x: 500,
    y: 600,
    width: 300,
    height: 20,
    angle: Math.PI / 12, // 15åº¦
    isStatic: true,
    friction: 0.001 // ä½æ‘©æ“¦ã§ã‚¹ãƒ ãƒ¼ã‚ºã«è»¢ãŒã‚‹
  },

  // ãƒˆãƒ¬ã‚¤è¨­å®š
  tray: {
    x: 650,
    y: 650,
    width: 100,
    height: 60,
    isStatic: true
  }
};
```

#### ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿè£…è©³ç´°

```javascript
class GachaPhysicsEngine {
  constructor(canvas, config = PHYSICS_CONFIG) {
    this.canvas = canvas;
    this.config = config;
    this.engine = null;
    this.render = null;
    this.runner = null;
    this.capsules = [];
    this.container = {};
    this.selectedCapsule = null;
    this.eventHandlers = new Map();
  }

  initialize(teams) {
    // ã‚¨ãƒ³ã‚¸ãƒ³ä½œæˆ
    this.engine = Matter.Engine.create({
      gravity: this.config.engine.gravity,
      enableSleeping: this.config.engine.enableSleeping
    });

    // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆ
    this.render = Matter.Render.create({
      canvas: this.canvas,
      engine: this.engine,
      options: this.config.render
    });

    // ãƒ©ãƒ³ãƒŠãƒ¼ä½œæˆ
    this.runner = Matter.Runner.create();

    // å®¹å™¨ä½œæˆ
    this.createContainer();

    // ãƒãƒ¼ãƒ ã‹ã‚‰ã‚«ãƒ—ã‚»ãƒ«ç”Ÿæˆï¼ˆåˆæœŸä½ç½®ã¯ç”»é¢å¤–ä¸Šéƒ¨ï¼‰
    teams.forEach((team, index) => {
      const capsule = this.createCapsule(
        team,
        100 + (index * 60), // Xä½ç½®ã‚’åˆ†æ•£
        -100 - (index * 70)  // Yä½ç½®ã‚’æ™‚é–“å·®ç”¨ã«åˆ†æ•£
      );
      this.capsules.push(capsule);
    });

    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹
    Matter.Render.run(this.render);
    Matter.Runner.run(this.runner, this.engine);
  }

  createCapsule(team, x, y) {
    const capsule = Matter.Bodies.circle(x, y, this.config.capsule.radius, {
      restitution: this.config.capsule.restitution,
      friction: this.config.capsule.friction,
      frictionAir: this.config.capsule.frictionAir,
      density: this.config.capsule.density,
      render: {
        ...this.config.capsule.render,
        fillStyle: team.color
      },
      label: `capsule_${team.id}`,
      teamData: team // ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿
    });

    return capsule;
  }

  createContainer() {
    const { floor, leftWall, rightWall } = this.config.container;

    this.container.floor = Matter.Bodies.rectangle(
      floor.x, floor.y, floor.width, floor.height,
      { isStatic: true, render: floor.render }
    );

    this.container.leftWall = Matter.Bodies.rectangle(
      leftWall.x, leftWall.y, leftWall.width, leftWall.height,
      { isStatic: true, render: leftWall.render }
    );

    this.container.rightWall = Matter.Bodies.rectangle(
      rightWall.x, rightWall.y, rightWall.width, rightWall.height,
      { isStatic: true, render: rightWall.render }
    );

    Matter.World.add(this.engine.world, [
      this.container.floor,
      this.container.leftWall,
      this.container.rightWall
    ]);
  }

  async executePhase1_Drop() {
    return new Promise((resolve) => {
      // ã‚«ãƒ—ã‚»ãƒ«ã‚’æ™‚é–“å·®ã§æŠ•å…¥
      this.capsules.forEach((capsule, index) => {
        setTimeout(() => {
          Matter.World.add(this.engine.world, capsule);
          this.emit('capsuleDropped', { capsule, index });
        }, index * 200); // 200msé–“éš”
      });

      // å…¨ã‚«ãƒ—ã‚»ãƒ«è½ä¸‹å®Œäº†ã¾ã§å¾…æ©Ÿ
      setTimeout(resolve, 2000);
    });
  }

  async executePhase2_Shuffle() {
    return new Promise((resolve) => {
      const interval = setInterval(() => {
        // å®¹å™¨ã‚’æºã‚‰ã™ï¼ˆå£ã‚’å¾®å°ç§»å‹•ï¼‰
        this.shakeContainer();

        // ã‚«ãƒ—ã‚»ãƒ«ã«ãƒ©ãƒ³ãƒ€ãƒ ãªåŠ›ã‚’åŠ ãˆã‚‹
        this.capsules.forEach(capsule => {
          Matter.Body.applyForce(capsule, capsule.position, {
            x: (Math.random() - 0.5) * 0.08,
            y: (Math.random() - 0.5) * 0.08
          });
        });
      }, 50);

      setTimeout(() => {
        clearInterval(interval);
        this.resetContainerPosition();
        resolve();
      }, 3000);
    });
  }

  async executePhase3_Extract() {
    return new Promise((resolve) => {
      // åº•ã«ç©´ã‚’é–‹ã‘ã‚‹ï¼ˆã‚»ãƒ³ã‚µãƒ¼è¿½åŠ ï¼‰
      const exitSensor = Matter.Bodies.rectangle(
        this.config.exitSensor.x,
        this.config.exitSensor.y,
        this.config.exitSensor.width,
        this.config.exitSensor.height,
        {
          isSensor: true,
          isStatic: true,
          render: this.config.exitSensor.render,
          label: 'exitSensor'
        }
      );

      Matter.World.add(this.engine.world, exitSensor);

      // è¡çªæ¤œçŸ¥
      const collisionHandler = (event) => {
        event.pairs.forEach(pair => {
          const { bodyA, bodyB } = pair;

          if (bodyA.label === 'exitSensor' || bodyB.label === 'exitSensor') {
            const capsule = bodyA.label.startsWith('capsule') ? bodyA : bodyB;

            if (!this.selectedCapsule && this.capsules.includes(capsule)) {
              this.selectedCapsule = capsule;
              this.highlightCapsule(capsule);
              this.setTimeScale(0.3); // ã‚¹ãƒ­ãƒ¼ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³
              this.emit('winnerSelected', capsule.teamData);

              setTimeout(() => {
                Matter.Events.off(this.engine, 'collisionStart', collisionHandler);
                resolve(capsule.teamData);
              }, 1000);
            }
          }
        });
      };

      Matter.Events.on(this.engine, 'collisionStart', collisionHandler);

      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆå¿µã®ãŸã‚ï¼‰
      setTimeout(() => {
        if (!this.selectedCapsule) {
          // ãƒ©ãƒ³ãƒ€ãƒ ã«é¸å‡º
          const randomCapsule = this.capsules[
            Math.floor(Math.random() * this.capsules.length)
          ];
          this.selectedCapsule = randomCapsule;
          Matter.Events.off(this.engine, 'collisionStart', collisionHandler);
          resolve(randomCapsule.teamData);
        }
      }, 5000);
    });
  }

  async executePhase4_Roll() {
    return new Promise((resolve) => {
      // ã‚¹ãƒ­ãƒ¼ãƒ—ã¨ãƒˆãƒ¬ã‚¤ã‚’è¿½åŠ 
      const slope = this.createSlope();
      const tray = this.createTray();

      Matter.World.add(this.engine.world, [slope, tray]);

      // é¸æŠã•ã‚ŒãŸã‚«ãƒ—ã‚»ãƒ«ã‚’ã‚¹ãƒ­ãƒ¼ãƒ—ã«ç§»å‹•
      Matter.Body.setPosition(this.selectedCapsule, {
        x: 450,
        y: 580
      });

      // é€šå¸¸é€Ÿåº¦ã«æˆ»ã™
      this.setTimeScale(1.0);

      // ãƒˆãƒ¬ã‚¤åˆ°ç€ã‚’å¾…ã¤
      setTimeout(resolve, 1500);
    });
  }

  shakeContainer() {
    const shakeAmount = 5;

    Matter.Body.translate(this.container.leftWall, {
      x: (Math.random() - 0.5) * shakeAmount,
      y: 0
    });

    Matter.Body.translate(this.container.rightWall, {
      x: (Math.random() - 0.5) * shakeAmount,
      y: 0
    });
  }

  resetContainerPosition() {
    Matter.Body.setPosition(this.container.leftWall, {
      x: this.config.container.leftWall.x,
      y: this.config.container.leftWall.y
    });

    Matter.Body.setPosition(this.container.rightWall, {
      x: this.config.container.rightWall.x,
      y: this.config.container.rightWall.y
    });
  }

  highlightCapsule(capsule) {
    capsule.render.strokeStyle = '#FFD700';
    capsule.render.lineWidth = 5;
  }

  setTimeScale(scale) {
    this.engine.timing.timeScale = scale;
  }

  createSlope() {
    return Matter.Bodies.rectangle(
      this.config.slope.x,
      this.config.slope.y,
      this.config.slope.width,
      this.config.slope.height,
      {
        isStatic: true,
        angle: this.config.slope.angle,
        friction: this.config.slope.friction
      }
    );
  }

  createTray() {
    return Matter.Bodies.rectangle(
      this.config.tray.x,
      this.config.tray.y,
      this.config.tray.width,
      this.config.tray.height,
      {
        isStatic: true
      }
    );
  }

  cleanup() {
    if (this.runner) {
      Matter.Runner.stop(this.runner);
    }
    if (this.render) {
      Matter.Render.stop(this.render);
    }
    if (this.engine) {
      Matter.World.clear(this.engine.world);
      Matter.Engine.clear(this.engine);
    }
    this.capsules = [];
    this.selectedCapsule = null;
  }

  on(event, callback) {
    if (!this.eventHandlers.has(event)) {
      this.eventHandlers.set(event, []);
    }
    this.eventHandlers.get(event).push(callback);
  }

  emit(event, data) {
    const handlers = this.eventHandlers.get(event);
    if (handlers) {
      handlers.forEach(callback => callback(data));
    }
  }
}
```

---

## 5. UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 5.1 ç”»é¢æ§‹æˆ

#### ãƒ¡ã‚¤ãƒ³ç”»é¢ (MainScreen)

```html
<div id="main-screen" class="screen active">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <h1 class="title">ãƒãƒ¼ãƒ æŠ½é¸ã‚¬ãƒãƒ£ã‚¬ãƒãƒ£</h1>
    <div class="stats">
      <span class="stat-item">
        <span class="stat-label">æœªå½“é¸:</span>
        <span class="stat-value" id="eligible-count">5</span>
      </span>
      <span class="stat-item">
        <span class="stat-label">ç·ãƒãƒ¼ãƒ æ•°:</span>
        <span class="stat-value" id="total-count">5</span>
      </span>
    </div>
  </header>

  <!-- æŠ½é¸ãƒœã‚¿ãƒ³ -->
  <div class="action-area">
    <button id="start-gacha-btn" class="btn-primary btn-large">
      æŠ½é¸é–‹å§‹
    </button>
  </div>

  <!-- ãƒãƒ¼ãƒ ä¸€è¦§ -->
  <section class="teams-section">
    <div class="section-header">
      <h2>ãƒãƒ¼ãƒ ä¸€è¦§</h2>
      <button id="add-team-btn" class="btn-secondary">
        + ãƒãƒ¼ãƒ è¿½åŠ 
      </button>
    </div>

    <div id="teams-grid" class="teams-grid">
      <!-- ãƒãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ãŒå‹•çš„ç”Ÿæˆã•ã‚Œã‚‹ -->
    </div>
  </section>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <footer class="footer">
    <button id="reset-all-btn" class="btn-danger btn-small">
      å…¨ãƒãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    </button>
    <button id="settings-btn" class="btn-secondary btn-small">
      è¨­å®š
    </button>
  </footer>
</div>
```

#### ãƒãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```html
<div class="team-card" data-team-id="{id}">
  <div class="team-card-header">
    <div class="capsule-preview" style="background-color: {color}"></div>
    <span class="team-status {status-class}">
      {status-text}
    </span>
  </div>

  <div class="team-card-body">
    <h3 class="team-name">{team-name}</h3>
  </div>

  <div class="team-card-actions">
    <button class="btn-icon edit-btn" data-action="edit">
      âœï¸
    </button>
    <button class="btn-icon toggle-btn" data-action="toggle">
      ğŸ”„
    </button>
    <button class="btn-icon delete-btn" data-action="delete">
      ğŸ—‘ï¸
    </button>
  </div>
</div>
```

#### ã‚¬ãƒãƒ£ç”»é¢ (GachaScreen)

```html
<div id="gacha-screen" class="screen">
  <header class="gacha-header">
    <h1>æŠ½é¸ä¸­...</h1>
  </header>

  <div class="gacha-container">
    <!-- Matter.js Canvas -->
    <canvas id="gacha-canvas"></canvas>

    <!-- ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤º -->
    <div class="phase-indicator">
      <div class="phase-text" id="phase-text">ã‚«ãƒ—ã‚»ãƒ«æŠ•å…¥ä¸­...</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>
  </div>
</div>
```

#### çµæœç”»é¢ (ResultScreen)

```html
<div id="result-screen" class="screen">
  <header class="result-header">
    <h1 class="result-title">ğŸ‰ å½“é¸ãƒãƒ¼ãƒ  ğŸ‰</h1>
  </header>

  <div class="result-container">
    <!-- ã‚«ãƒ—ã‚»ãƒ«é–‹å°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="capsule-reveal">
      <div class="capsule-half capsule-left" id="capsule-left"></div>
      <div class="capsule-half capsule-right" id="capsule-right"></div>
      <div class="winner-name" id="winner-name">
        <!-- ãƒãƒ¼ãƒ åãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
      </div>
    </div>

    <!-- ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
    <div id="confetti-container" class="confetti-container">
      <!-- ç´™å¹é›ªãŒå‹•çš„ç”Ÿæˆã•ã‚Œã‚‹ -->
    </div>
  </div>

  <footer class="result-footer">
    <button id="back-to-main-btn" class="btn-primary btn-large">
      ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
    </button>
  </footer>
</div>
```

### 5.2 uiController.js - UIç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

```javascript
class UIController {
  constructor(teamManager, gachaOrchestrator) {
    this.teamManager = teamManager;
    this.gachaOrchestrator = gachaOrchestrator;
    this.currentScreen = 'main';
    this.initializeEventListeners();
  }

  initializeEventListeners() {
    // ãƒ¡ã‚¤ãƒ³ç”»é¢
    document.getElementById('start-gacha-btn')
      .addEventListener('click', () => this.handleStartGacha());

    document.getElementById('add-team-btn')
      .addEventListener('click', () => this.handleAddTeam());

    document.getElementById('reset-all-btn')
      .addEventListener('click', () => this.handleResetAll());

    // ãƒãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
    document.getElementById('teams-grid')
      .addEventListener('click', (e) => this.handleTeamCardAction(e));

    // çµæœç”»é¢
    document.getElementById('back-to-main-btn')
      .addEventListener('click', () => this.navigateTo('main'));

    // ãƒãƒ¼ãƒ ç®¡ç†ã‚¤ãƒ™ãƒ³ãƒˆ
    this.teamManager.on('teamAdded', () => this.renderTeams());
    this.teamManager.on('teamUpdated', () => this.renderTeams());
    this.teamManager.on('teamDeleted', () => this.renderTeams());
    this.teamManager.on('allTeamsReset', () => this.renderTeams());
  }

  renderTeams() {
    const grid = document.getElementById('teams-grid');
    const teams = this.teamManager.getAllTeams();

    grid.innerHTML = teams.map(team => this.createTeamCard(team)).join('');

    // çµ±è¨ˆæ›´æ–°
    this.updateStats();
  }

  createTeamCard(team) {
    const statusClass = team.isWinner ? 'status-winner' : 'status-eligible';
    const statusText = team.isWinner ? 'å½“é¸æ¸ˆã¿' : 'æœªå½“é¸';

    return `
      <div class="team-card ${team.isWinner ? 'winner' : ''}"
           data-team-id="${team.id}">
        <div class="team-card-header">
          <div class="capsule-preview"
               style="background-color: ${team.color}"></div>
          <span class="team-status ${statusClass}">${statusText}</span>
        </div>
        <div class="team-card-body">
          <h3 class="team-name">${this.escapeHtml(team.name)}</h3>
        </div>
        <div class="team-card-actions">
          <button class="btn-icon edit-btn"
                  data-action="edit"
                  title="ç·¨é›†">âœï¸</button>
          <button class="btn-icon toggle-btn"
                  data-action="toggle"
                  title="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ‡æ›¿">ğŸ”„</button>
          <button class="btn-icon delete-btn"
                  data-action="delete"
                  title="å‰Šé™¤">ğŸ—‘ï¸</button>
        </div>
      </div>
    `;
  }

  handleTeamCardAction(e) {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;

    const card = btn.closest('.team-card');
    const teamId = card.dataset.teamId;
    const action = btn.dataset.action;

    switch (action) {
      case 'edit':
        this.handleEditTeam(teamId);
        break;
      case 'toggle':
        this.handleToggleStatus(teamId);
        break;
      case 'delete':
        this.handleDeleteTeam(teamId);
        break;
    }
  }

  handleStartGacha() {
    const eligibleTeams = this.teamManager.getEligibleTeams();

    if (eligibleTeams.length === 0) {
      this.showError('æœªå½“é¸ã®ãƒãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    this.navigateTo('gacha');
    this.gachaOrchestrator.startGacha(eligibleTeams);
  }

  handleAddTeam() {
    const name = prompt('ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');

    if (!name) return;

    try {
      this.teamManager.addTeam(name);
      this.showSuccess('ãƒãƒ¼ãƒ ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    } catch (error) {
      this.showError(error.message);
    }
  }

  handleEditTeam(teamId) {
    const team = this.teamManager.getAllTeams().find(t => t.id === teamId);
    const newName = prompt('æ–°ã—ã„ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', team.name);

    if (!newName || newName === team.name) return;

    try {
      this.teamManager.updateTeam(teamId, { name: newName });
      this.showSuccess('ãƒãƒ¼ãƒ åã‚’æ›´æ–°ã—ã¾ã—ãŸ');
    } catch (error) {
      this.showError(error.message);
    }
  }

  handleToggleStatus(teamId) {
    const team = this.teamManager.getAllTeams().find(t => t.id === teamId);

    try {
      this.teamManager.updateTeam(teamId, { isWinner: !team.isWinner });
    } catch (error) {
      this.showError(error.message);
    }
  }

  handleDeleteTeam(teamId) {
    if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹?')) return;

    try {
      this.teamManager.deleteTeam(teamId);
      this.showSuccess('ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    } catch (error) {
      this.showError(error.message);
    }
  }

  handleResetAll() {
    if (!confirm('å…¨ãƒãƒ¼ãƒ ã‚’æœªå½“é¸ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹?')) return;

    this.teamManager.resetAllTeams();
    this.showSuccess('å…¨ãƒãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
  }

  navigateTo(screenName) {
    // ç¾åœ¨ã®ç”»é¢ã‚’éè¡¨ç¤º
    document.querySelectorAll('.screen').forEach(screen => {
      screen.classList.remove('active');
    });

    // æŒ‡å®šç”»é¢ã‚’è¡¨ç¤º
    document.getElementById(`${screenName}-screen`).classList.add('active');
    this.currentScreen = screenName;
  }

  updateStats() {
    const teams = this.teamManager.getAllTeams();
    const eligible = this.teamManager.getEligibleTeams();

    document.getElementById('total-count').textContent = teams.length;
    document.getElementById('eligible-count').textContent = eligible.length;

    // æŠ½é¸ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹
    const startBtn = document.getElementById('start-gacha-btn');
    startBtn.disabled = eligible.length === 0;
  }

  showError(message) {
    // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
    this.showToast(message, 'error');
  }

  showSuccess(message) {
    this.showToast(message, 'success');
  }

  showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;

    document.body.appendChild(toast);

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«å‰Šé™¤
    setTimeout(() => {
      toast.classList.add('show');
    }, 10);

    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
}
```

---

## 6. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»æ¼”å‡ºè¨­è¨ˆ

### 6.1 gachaOrchestrator.js - æ¼”å‡ºçµ±æ‹¬ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

```javascript
class GachaOrchestrator {
  constructor(physicsEngine, animationManager, audioManager, teamManager, uiController) {
    this.physics = physicsEngine;
    this.animation = animationManager;
    this.audio = audioManager;
    this.teamManager = teamManager;
    this.ui = uiController;
    this.isRunning = false;
  }

  async startGacha(eligibleTeams) {
    if (this.isRunning) return;

    this.isRunning = true;

    try {
      // 1. ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–
      this.physics.initialize(eligibleTeams);

      // 2. ãƒ•ã‚§ãƒ¼ã‚º1: ã‚«ãƒ—ã‚»ãƒ«æŠ•å…¥ï¼ˆ2ç§’ï¼‰
      this.updatePhaseText('ã‚«ãƒ—ã‚»ãƒ«æŠ•å…¥ä¸­...');
      this.audio.playDropSound();
      await this.physics.executePhase1_Drop();
      await this.sleep(500);

      // 3. ãƒ•ã‚§ãƒ¼ã‚º2: ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆ3ç§’ï¼‰
      this.updatePhaseText('ã‚·ãƒ£ãƒƒãƒ•ãƒ«ä¸­...');
      this.audio.playShuffleSound();
      await this.physics.executePhase2_Shuffle();
      await this.sleep(500);

      // 4. ãƒ•ã‚§ãƒ¼ã‚º3: å–ã‚Šå‡ºã—ï¼ˆ2ç§’ï¼‰
      this.updatePhaseText('æŠ½é¸ä¸­...');
      this.audio.playExtractionSound();
      const winner = await this.physics.executePhase3_Extract();
      await this.sleep(500);

      // 5. ãƒ•ã‚§ãƒ¼ã‚º4: è»¢ãŒã‚Šï¼ˆ1.5ç§’ï¼‰
      this.updatePhaseText('å½“é¸ã‚«ãƒ—ã‚»ãƒ«å–ã‚Šå‡ºã—ä¸­...');
      this.audio.playRollSound();
      await this.physics.executePhase4_Roll();

      // 6. ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      this.physics.cleanup();

      // 7. çµæœç”»é¢ã¸é·ç§»
      this.ui.navigateTo('result');

      // 8. ãƒ•ã‚§ãƒ¼ã‚º5: é–‹å°æ¼”å‡ºï¼ˆ2ç§’ï¼‰
      await this.animation.playCapsuleReveal(winner);

      // 9. ãƒãƒ¼ãƒ ã‚’å½“é¸æ¸ˆã¿ã«ãƒãƒ¼ã‚¯
      this.teamManager.markAsWinner(winner.id);

      // 10. å®Œäº†
      this.isRunning = false;

    } catch (error) {
      console.error('Gacha error:', error);
      this.ui.showError('æŠ½é¸ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      this.physics.cleanup();
      this.ui.navigateTo('main');
      this.isRunning = false;
    }
  }

  updatePhaseText(text) {
    const phaseElement = document.getElementById('phase-text');
    if (phaseElement) {
      phaseElement.textContent = text;
    }
  }

  sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

### 6.2 animationManager.js - CSS ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†

```javascript
class AnimationManager {
  constructor() {
    this.confettiCount = 100;
  }

  async playCapsuleReveal(winner) {
    // ã‚«ãƒ—ã‚»ãƒ«è‰²è¨­å®š
    const capsuleLeft = document.getElementById('capsule-left');
    const capsuleRight = document.getElementById('capsule-right');

    capsuleLeft.style.backgroundColor = winner.color;
    capsuleRight.style.backgroundColor = winner.color;

    // é–‹å°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    await this.sleep(500);
    capsuleLeft.classList.add('open');
    capsuleRight.classList.add('open');

    // ãƒãƒ¼ãƒ åè¡¨ç¤º
    await this.sleep(800);
    const winnerName = document.getElementById('winner-name');
    winnerName.textContent = winner.name;
    winnerName.classList.add('reveal');

    // ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬
    const audioManager = new AudioManager();
    audioManager.playFanfare();

    // ç´™å¹é›ª
    this.createConfetti();

    await this.sleep(2000);
  }

  createConfetti() {
    const container = document.getElementById('confetti-container');
    container.innerHTML = ''; // ã‚¯ãƒªã‚¢

    const colors = ['#FF6B6B', '#4ECDC4', '#95E1D3', '#FFE66D', '#C77DFF'];

    for (let i = 0; i < this.confettiCount; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';

      // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ãƒ»è‰²ãƒ»ã‚µã‚¤ã‚º
      confetti.style.left = Math.random() * 100 + '%';
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.width = (Math.random() * 10 + 5) + 'px';
      confetti.style.height = confetti.style.width;
      confetti.style.animationDelay = (Math.random() * 3) + 's';
      confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';

      container.appendChild(confetti);
    }
  }

  sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

### 6.3 audioManager.js - åŠ¹æœéŸ³ç®¡ç†

```javascript
class AudioManager {
  constructor() {
    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    this.masterGain = this.audioContext.createGain();
    this.masterGain.connect(this.audioContext.destination);
    this.masterGain.gain.value = 0.3; // éŸ³é‡30%
  }

  playDropSound() {
    const oscillator = this.audioContext.createOscillator();
    const gainNode = this.audioContext.createGain();

    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
    oscillator.frequency.exponentialRampToValueAtTime(400, this.audioContext.currentTime + 0.1);

    gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);

    oscillator.connect(gainNode);
    gainNode.connect(this.masterGain);

    oscillator.start();
    oscillator.stop(this.audioContext.currentTime + 0.1);
  }

  playShuffleSound() {
    // ãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚ºã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«éŸ³ã‚’å†ç¾
    const bufferSize = this.audioContext.sampleRate * 3; // 3ç§’
    const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
    const output = buffer.getChannelData(0);

    for (let i = 0; i < bufferSize; i++) {
      output[i] = (Math.random() * 2 - 1) * 0.1; // ãƒã‚¤ã‚ºç”Ÿæˆ
    }

    const source = this.audioContext.createBufferSource();
    source.buffer = buffer;
    source.connect(this.masterGain);
    source.start();
  }

  playExtractionSound() {
    // ä½éŸ³ã®ã‚´ãƒ­ã‚´ãƒ­éŸ³
    const oscillator = this.audioContext.createOscillator();
    const gainNode = this.audioContext.createGain();

    oscillator.type = 'triangle';
    oscillator.frequency.setValueAtTime(100, this.audioContext.currentTime);

    gainNode.gain.setValueAtTime(0.15, this.audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 2);

    oscillator.connect(gainNode);
    gainNode.connect(this.masterGain);

    oscillator.start();
    oscillator.stop(this.audioContext.currentTime + 2);
  }

  playRollSound() {
    // è»¢ãŒã‚‹éŸ³ï¼ˆæ¸›è¡°ã™ã‚‹é€£ç¶šéŸ³ï¼‰
    const oscillator = this.audioContext.createOscillator();
    const gainNode = this.audioContext.createGain();

    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(200, this.audioContext.currentTime);
    oscillator.frequency.exponentialRampToValueAtTime(150, this.audioContext.currentTime + 1.5);

    gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 1.5);

    oscillator.connect(gainNode);
    gainNode.connect(this.masterGain);

    oscillator.start();
    oscillator.stop(this.audioContext.currentTime + 1.5);
  }

  playFanfare() {
    // ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬ï¼ˆC-E-G-Cï¼‰
    const notes = [
      { freq: 523, duration: 0.3 }, // C5
      { freq: 659, duration: 0.3 }, // E5
      { freq: 784, duration: 0.3 }, // G5
      { freq: 1047, duration: 0.5 } // C6
    ];

    notes.forEach((note, i) => {
      setTimeout(() => {
        this.playNote(note.freq, note.duration);
      }, i * 200);
    });
  }

  playNote(frequency, duration) {
    const oscillator = this.audioContext.createOscillator();
    const gainNode = this.audioContext.createGain();

    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);

    gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);

    oscillator.connect(gainNode);
    gainNode.connect(this.masterGain);

    oscillator.start();
    oscillator.stop(this.audioContext.currentTime + duration);
  }

  setVolume(volume) {
    // 0-1ã®ç¯„å›²
    this.masterGain.gain.value = Math.max(0, Math.min(1, volume));
  }
}
```

---

## 7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ

### 7.1 ã‚¨ãƒ©ãƒ¼åˆ†é¡

```javascript
class GachaError extends Error {
  constructor(message, code, recoverable = false) {
    super(message);
    this.name = 'GachaError';
    this.code = code;
    this.recoverable = recoverable;
  }
}

// ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰å®šç¾©
const ERROR_CODES = {
  // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼
  STORAGE_NOT_SUPPORTED: 'E001',
  STORAGE_QUOTA_EXCEEDED: 'E002',
  STORAGE_CORRUPT_DATA: 'E003',

  // ãƒãƒ¼ãƒ ç®¡ç†ã‚¨ãƒ©ãƒ¼
  TEAM_NAME_EMPTY: 'E101',
  TEAM_NAME_TOO_LONG: 'E102',
  TEAM_NAME_DUPLICATE: 'E103',
  TEAM_NOT_FOUND: 'E104',
  MAX_TEAMS_EXCEEDED: 'E105',

  // æŠ½é¸ã‚¨ãƒ©ãƒ¼
  NO_ELIGIBLE_TEAMS: 'E201',
  GACHA_ALREADY_RUNNING: 'E202',
  PHYSICS_ENGINE_ERROR: 'E203',

  // ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ã‚¨ãƒ©ãƒ¼
  WEB_AUDIO_NOT_SUPPORTED: 'E301',
  CANVAS_NOT_SUPPORTED: 'E302'
};
```

### 7.2 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥

```javascript
class ErrorHandler {
  static handle(error) {
    console.error('Error:', error);

    if (error instanceof GachaError) {
      return this.handleGachaError(error);
    }

    // äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼
    return this.handleUnexpectedError(error);
  }

  static handleGachaError(error) {
    const messages = {
      [ERROR_CODES.STORAGE_NOT_SUPPORTED]:
        'ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“',
      [ERROR_CODES.STORAGE_QUOTA_EXCEEDED]:
        'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™',
      [ERROR_CODES.TEAM_NAME_EMPTY]:
        'ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
      [ERROR_CODES.TEAM_NAME_TOO_LONG]:
        'ãƒãƒ¼ãƒ åã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„',
      [ERROR_CODES.TEAM_NAME_DUPLICATE]:
        'ãã®ãƒãƒ¼ãƒ åã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™',
      [ERROR_CODES.MAX_TEAMS_EXCEEDED]:
        `ãƒãƒ¼ãƒ ã¯æœ€å¤§${MAX_TEAMS}å€‹ã¾ã§ã§ã™`,
      [ERROR_CODES.NO_ELIGIBLE_TEAMS]:
        'æœªå½“é¸ã®ãƒãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“',
      [ERROR_CODES.GACHA_ALREADY_RUNNING]:
        'æŠ½é¸ãŒæ—¢ã«å®Ÿè¡Œä¸­ã§ã™'
    };

    const message = messages[error.code] || error.message;

    return {
      message,
      recoverable: error.recoverable,
      action: this.getRecoveryAction(error.code)
    };
  }

  static handleUnexpectedError(error) {
    return {
      message: 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
      recoverable: false,
      action: 'ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„'
    };
  }

  static getRecoveryAction(code) {
    const actions = {
      [ERROR_CODES.STORAGE_QUOTA_EXCEEDED]:
        'ä¸è¦ãªãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„',
      [ERROR_CODES.NO_ELIGIBLE_TEAMS]:
        'ã€Œå…¨ãƒãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„',
      [ERROR_CODES.MAX_TEAMS_EXCEEDED]:
        'ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„'
    };

    return actions[code] || null;
  }
}
```

---

## 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 8.1 æœ€é©åŒ–æˆ¦ç•¥

#### ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–

```javascript
const PERFORMANCE_CONFIG = {
  // Matter.jsæœ€é©åŒ–
  physics: {
    positionIterations: 6,  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ˆã‚Šå°‘ãªã
    velocityIterations: 4,  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ˆã‚Šå°‘ãªã
    enableSleeping: true,   // é™æ­¢ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¹ãƒªãƒ¼ãƒ—
    constraintIterations: 2
  },

  // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–
  render: {
    pixelRatio: Math.min(window.devicePixelRatio, 2), // æœ€å¤§2å€ã¾ã§
    hasBounds: true,
    showAngleIndicator: false,
    showIds: false,
    showVertexNumbers: false
  },

  // ã‚«ãƒ—ã‚»ãƒ«æ•°åˆ¶é™
  maxCapsules: 20,

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³FPS
  targetFPS: 60
};
```

#### ãƒ¡ãƒ¢ãƒªç®¡ç†

```javascript
class ResourceManager {
  constructor() {
    this.resources = new Map();
  }

  register(key, resource, cleanup) {
    this.resources.set(key, { resource, cleanup });
  }

  cleanup(key) {
    const entry = this.resources.get(key);
    if (entry) {
      entry.cleanup(entry.resource);
      this.resources.delete(key);
    }
  }

  cleanupAll() {
    this.resources.forEach((entry, key) => {
      entry.cleanup(entry.resource);
    });
    this.resources.clear();
  }
}

// ä½¿ç”¨ä¾‹
const resourceManager = new ResourceManager();

// ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³ç™»éŒ²
resourceManager.register('physicsEngine', physicsEngine, (engine) => {
  engine.cleanup();
});

// ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç™»éŒ²
resourceManager.register('audioContext', audioContext, (ctx) => {
  ctx.close();
});
```

#### DOMæ“ä½œã®æœ€é©åŒ–

```javascript
class DOMOptimizer {
  static batchUpdate(updates) {
    // DOMæ›´æ–°ã‚’ä¸€æ‹¬å®Ÿè¡Œ
    requestAnimationFrame(() => {
      updates.forEach(update => update());
    });
  }

  static debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  static throttle(func, limit) {
    let inThrottle;
    return function(...args) {
      if (!inThrottle) {
        func.apply(this, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    };
  }
}
```

---

## 9. å®Ÿè£…è©³ç´°

### 9.1 ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆï¼ˆæœ€çµ‚ç‰ˆï¼‰

```
gacha-roulette/
â”œâ”€â”€ index.html
â”œâ”€â”€ css/
â”‚   â”œâ”€â”€ style.css
â”‚   â”œâ”€â”€ animations.css
â”‚   â””â”€â”€ responsive.css
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ app.js                    # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ storage.js                # ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”œâ”€â”€ teamManager.js            # ãƒãƒ¼ãƒ ç®¡ç†
â”‚   â”œâ”€â”€ gachaOrchestrator.js      # æ¼”å‡ºçµ±æ‹¬
â”‚   â”œâ”€â”€ gacha.js                  # ç‰©ç†æ¼”ç®—ã‚¨ãƒ³ã‚¸ãƒ³
â”‚   â”œâ”€â”€ animationManager.js       # ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†
â”‚   â”œâ”€â”€ audioManager.js           # éŸ³å£°ç®¡ç†
â”‚   â”œâ”€â”€ uiController.js           # UIåˆ¶å¾¡
â”‚   â”œâ”€â”€ errorHandler.js           # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
â”‚   â””â”€â”€ utils.js                  # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”œâ”€â”€ assets/
â”‚   â””â”€â”€ (å°†æ¥çš„ã«éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãªã©)
â””â”€â”€ docs/
    â”œâ”€â”€ gacha_implementation_plan.md
    â””â”€â”€ detailed_design.md
```

### 9.2 app.js - ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

```javascript
// app.js - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ

class GachaApp {
  constructor() {
    this.storage = null;
    this.teamManager = null;
    this.uiController = null;
    this.gachaOrchestrator = null;
  }

  async initialize() {
    try {
      // ã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–
      this.storage = new StorageService();
      this.teamManager = new TeamManager(this.storage);

      // UIåˆæœŸåŒ–ï¼ˆå¾Œã§ç‰©ç†ã‚¨ãƒ³ã‚¸ãƒ³ãªã©ã‚’æ¸¡ã™ï¼‰
      this.uiController = new UIController(this.teamManager, null);

      // åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      this.uiController.renderTeams();

      console.log('App initialized successfully');
    } catch (error) {
      const handled = ErrorHandler.handle(error);
      alert(handled.message);

      if (!handled.recoverable) {
        console.error('Fatal error:', error);
      }
    }
  }

  initializeGachaOrchestrator() {
    // é…å»¶åˆæœŸåŒ–ï¼ˆã‚¬ãƒãƒ£å®Ÿè¡Œæ™‚ï¼‰
    const canvas = document.getElementById('gacha-canvas');
    const physicsEngine = new GachaPhysicsEngine(canvas);
    const animationManager = new AnimationManager();
    const audioManager = new AudioManager();

    this.gachaOrchestrator = new GachaOrchestrator(
      physicsEngine,
      animationManager,
      audioManager,
      this.teamManager,
      this.uiController
    );

    // UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«è¨­å®š
    this.uiController.gachaOrchestrator = this.gachaOrchestrator;
  }
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
document.addEventListener('DOMContentLoaded', () => {
  const app = new GachaApp();
  app.initialize();

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
  window.gachaApp = app;
});
```

### 9.3 index.html æ§‹é€ ï¼ˆæ¦‚è¦ï¼‰

```html
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ¼ãƒ æŠ½é¸ã‚¬ãƒãƒ£ã‚¬ãƒãƒ£</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/animations.css">
</head>
<body>
  <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
  <div id="main-screen" class="screen active">
    <!-- ... -->
  </div>

  <!-- ã‚¬ãƒãƒ£ç”»é¢ -->
  <div id="gacha-screen" class="screen">
    <canvas id="gacha-canvas"></canvas>
    <!-- ... -->
  </div>

  <!-- çµæœç”»é¢ -->
  <div id="result-screen" class="screen">
    <!-- ... -->
  </div>

  <!-- Matter.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

  <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="js/utils.js"></script>
  <script src="js/errorHandler.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/teamManager.js"></script>
  <script src="js/audioManager.js"></script>
  <script src="js/animationManager.js"></script>
  <script src="js/gacha.js"></script>
  <script src="js/gachaOrchestrator.js"></script>
  <script src="js/uiController.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
```

---

## 10. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: åŸºæœ¬æ§‹é€ 
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ä½œæˆ
- [ ] HTMLåŸºæœ¬æ§‹é€ 
- [ ] CSSåŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
- [ ] Matter.js CDNèª­ã¿è¾¼ã¿

### Phase 2: ãƒ‡ãƒ¼ã‚¿å±¤
- [ ] StorageServiceå®Ÿè£…
- [ ] TeamManagerå®Ÿè£…
- [ ] ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
- [ ] LocalStorageå‹•ä½œç¢ºèª

### Phase 3: UIå±¤
- [ ] ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®Ÿè£…
- [ ] ãƒãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- [ ] UIControllerå®Ÿè£…
- [ ] ç”»é¢é·ç§»ãƒ­ã‚¸ãƒƒã‚¯

### Phase 4: ç‰©ç†æ¼”ç®—
- [ ] GachaPhysicsEngineå®Ÿè£…
- [ ] ã‚«ãƒ—ã‚»ãƒ«ãƒ»å®¹å™¨ç”Ÿæˆ
- [ ] ãƒ•ã‚§ãƒ¼ã‚º1-4å®Ÿè£…
- [ ] è¡çªæ¤œçŸ¥ãƒ†ã‚¹ãƒˆ

### Phase 5: æ¼”å‡º
- [ ] AnimationManagerå®Ÿè£…
- [ ] CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©
- [ ] AudioManagerå®Ÿè£…
- [ ] GachaOrchestratorçµ±åˆ

### Phase 6: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [ ] ErrorHandlerå®Ÿè£…
- [ ] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
- [ ] ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºUI

### Phase 7: æœ€é©åŒ–
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°
- [ ] ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ

### Phase 8: ãƒ†ã‚¹ãƒˆ
- [ ] å…¨æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª
- [ ] ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ç¢ºèª

---

## 11. ã¾ã¨ã‚

ã“ã®è©³ç´°è¨­è¨ˆæ›¸ã§ã¯ã€ä»¥ä¸‹ã®å†…å®¹ã‚’å®šç¾©ã—ã¾ã—ãŸ:

1. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: 3å±¤ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ï¼ˆView / Logic / Serviceï¼‰
2. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ**: 8ã¤ã®ä¸»è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ãã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
3. **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: çŠ¶æ…‹ç®¡ç†ã¨ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
4. **ç‰©ç†æ¼”ç®—**: Matter.jsã‚’ä½¿ç”¨ã—ãŸè©³ç´°ãªç‰©ç†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
5. **UIè¨­è¨ˆ**: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã®å†åˆ©ç”¨å¯èƒ½ãªæ§‹é€ 
6. **ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³**: CSS + JavaScript ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¼”å‡º
7. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: å …ç‰¢ãªã‚¨ãƒ©ãƒ¼åˆ†é¡ã¨å›å¾©æˆ¦ç•¥
8. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ»ãƒ¡ãƒ¢ãƒªæœ€é©åŒ–æ‰‹æ³•

ã“ã®è¨­è¨ˆã«åŸºã¥ã„ã¦å®Ÿè£…ã‚’é€²ã‚ã‚‹ã“ã¨ã§ã€ä¿å®ˆæ€§ãƒ»æ‹¡å¼µæ€§ã®é«˜ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚
